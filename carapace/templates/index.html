<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Carapace Graph</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script defer src="https://unpkg.com/alpinejs@3.14.1/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <style>
      :root {
        --bg: #f6f6ef;
        --panel: #fffdf8;
        --text: #1f2a37;
        --muted: #6b7280;
        --line: #d9d4c7;
        --accent: #0f766e;
      }
      body { margin: 0; font-family: ui-sans-serif, -apple-system, Segoe UI, sans-serif; background: var(--bg); color: var(--text); }
      .layout { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
      .sidebar { border-right: 1px solid var(--line); background: var(--panel); overflow: auto; padding: 16px; }
      .main { display: grid; grid-template-rows: auto 1fr; }
      .toolbar { display: flex; gap: 8px; align-items: center; border-bottom: 1px solid var(--line); background: var(--panel); padding: 12px 16px; }
      .toolbar input, .toolbar select { padding: 6px 8px; border: 1px solid var(--line); border-radius: 8px; background: white; }
      #graph { width: 100%; height: 100%; }
      .cluster-card { border: 1px solid var(--line); border-radius: 10px; padding: 10px; margin-bottom: 8px; background: #ffffff; }
      .cluster-card h4 { margin: 0 0 6px; font-size: 14px; }
      .muted { color: var(--muted); font-size: 12px; }
      .pill { display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:11px; }
      button { border:1px solid var(--line); background:white; border-radius:8px; padding:6px 10px; cursor:pointer; }
      button:hover { border-color: var(--accent); color: var(--accent); }
    </style>
  </head>
  <body x-data="graphPage()" x-init="init()">
    <div class="layout">
      <aside class="sidebar">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2 style="margin:0;">Clusters</h2>
          <span class="muted" x-text="repo"></span>
        </div>
        <div class="muted" style="margin-bottom:12px;">Obsidian-style triage graph</div>

        <div style="display:flex; gap:6px; margin-bottom:10px;">
          <select x-model="kind" @change="reloadClusters()">
            <option value="all">all</option>
            <option value="duplicate_candidate">duplicate_candidate</option>
            <option value="linked_pair">linked_pair</option>
            <option value="mixed_pair">mixed_pair</option>
          </select>
          <input type="number" min="1" x-model="minMembers" @change="reloadClusters()" title="min members" />
        </div>

        <div id="clusters"
             hx-get="/ui/fragments/clusters"
             hx-trigger="load"
             :hx-vals="JSON.stringify({repo: repo, kind: kind, min_members: Number(minMembers)})"
             hx-swap="innerHTML"></div>
      </aside>

      <main class="main">
        <div class="toolbar">
          <label>Repo</label>
          <select x-model="repo" @change="reloadAll()">
            {% for r in repos %}
            <option value="{{ r }}" {% if r == repo %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
          </select>

          <label>Min edge</label>
          <input type="number" step="0.01" min="0" max="1" x-model="minEdge" @change="reloadGraph()" />

          <button @click="focusAll()">all clusters</button>
          <span class="muted" x-text="graphStats"></span>
        </div>
        <div id="graph"></div>
      </main>
    </div>

    <script>
      function graphPage() {
        return {
          repo: {{ repo|tojson }},
          kind: "all",
          minMembers: 2,
          minEdge: 0.15,
          selectedCluster: null,
          cy: null,
          graphStats: "",

          init() {
            window.carapaceSelectCluster = (clusterId) => {
              this.selectedCluster = clusterId;
              this.reloadGraph();
            };
            this.reloadGraph();
          },

          reloadClusters() {
            const el = document.getElementById("clusters");
            el.setAttribute("hx-vals", JSON.stringify({ repo: this.repo, kind: this.kind, min_members: Number(this.minMembers) }));
            htmx.trigger(el, "load");
          },

          reloadAll() {
            this.selectedCluster = null;
            this.reloadClusters();
            this.reloadGraph();
          },

          focusAll() {
            this.selectedCluster = null;
            this.reloadGraph();
          },

          async reloadGraph() {
            const params = new URLSearchParams({ min_edge_score: String(this.minEdge) });
            if (this.selectedCluster) params.set("cluster_id", this.selectedCluster);
            const res = await fetch(`/api/repos/${encodeURIComponent(this.repo)}/graph?${params.toString()}`);
            const payload = await res.json();
            this.graphStats = `${payload.node_count} nodes / ${payload.edge_count} edges`;
            this.renderGraph(payload.elements);
          },

          renderGraph(elements) {
            if (this.cy) this.cy.destroy();
            this.cy = cytoscape({
              container: document.getElementById("graph"),
              elements,
              style: [
                { selector: "node", style: { "label": "data(label)", "font-size": 10, "text-wrap": "wrap", "text-max-width": 120, "background-color": "#94a3b8", width: "data(size)", height: "data(size)" } },
                { selector: 'node[kind = "cluster"]', style: { "background-color": "#0f766e", color: "#fff" } },
                { selector: 'node[kind = "pr"]', style: { "background-color": "#2563eb" } },
                { selector: 'node[kind = "issue"]', style: { "background-color": "#dc2626" } },
                { selector: 'node[kind = "author"]', style: { "background-color": "#7c3aed" } },
                { selector: 'edge[kind = "similarity"]', style: { "line-color": "#475569", width: "mapData(weight, 0, 1, 1, 6)", "curve-style": "bezier", opacity: 0.65 } },
                { selector: 'edge[kind = "in_cluster"]', style: { "line-color": "#0f766e", width: 1.2, opacity: 0.4 } },
                { selector: 'edge[kind = "authored_by"]', style: { "line-color": "#7c3aed", width: 1, opacity: 0.45 } },
                { selector: 'edge[kind = "references"]', style: { "line-color": "#b45309", width: 2.2, "line-style": "dashed", opacity: 0.85 } },
              ],
              layout: { name: "cose", animate: false, padding: 24 },
            });
          },
        };
      }
    </script>
  </body>
</html>
